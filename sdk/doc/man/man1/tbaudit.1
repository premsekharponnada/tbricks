.\" Automatically generated by Pandoc 2.9.2.1
.\"
.TH "tbaudit" "1" "2020-07-20" "Tbricks" "tbaudit man page"
.hy
.SH NAME
.PP
\f[C]tbaudit\f[R] \[en] displays audit log entries.
.SH SYNOPSIS
.PP
\f[C]tbaudit --help\f[R]
.PP
\f[C]tbaudit dump\f[R] <path_to_audit_directory>
.PP
\f[C]tbaudit\f[R] [<component> | <service>] [<object_type>]
[<expression>] [<options>]
.PP
\f[C]tbaudit archive\f[R] <component_name> <destination_directory>
[\f[C]-k date le\f[R] <split_date>]
.PP
\f[C]tbaudit restore\f[R] <component_name> <path_to archive_file>
[\f[C]--dry_run\f[R]]
.SH DESCRIPTION
.PP
\f[C]tbaudit\f[R] is a command-line utility which provides convenient
access to the logs related to the different object types in the tbricks
system.
.PP
Like \f[C]tblog\f[R], \f[C]tbaudit\f[R] uses the admin tools
infrastructure to find connection information about the components it
connects to and directly interacts with them to extract log messages
that matched the specified expression.
The administration infrastructure is specified using the
TBRICKS_ADMIN_CENTER environment variable.
.SS Identifiers
.PP
Please see \f[C]tbintro(1)\f[R] for information about the identifiers
used for systems, components, and services.
.SS Environment variables
.PP
Please see the \f[B]Environment variables\f[R] section in
\f[C]tbintro(1)\f[R].
.SS Expressions
.PP
Please see the \f[B]Expressions\f[R] section in \f[C]tblog(1)\f[R] for
general overview.
.PP
\f[C]tbaudit\f[R] supports the following keys:
.TP
cash
Cash identifier.
.TP
trade
Trade identifier.
.TP
order
Order identifier.
.TP
date
Log entry created date.
.TP
stream_item
Stream identifier.
.TP
resource
Resource identifier.
.TP
resource_name
Symbolic resource name.
.TP
instrument
Instrument identifier.
.TP
instrument_group
Instrument group identifier.
.TP
parameter
Parameter identifier.
.TP
strategy
Strategy identifier.
.TP
portfolio
Portfolio identifier.
.TP
tree_node
Tree node identifier.
.SH SUBCOMMANDS
.PP
The following subcommands are supported:
.TP
\f[B]\f[CB]tbaudit\f[B]\f[R] <path_to_audit_data_directory>
Dumps audit data to stdout.
.TP
\f[B]\f[CB]tbaudit\f[B]\f[R] [<component> | <service>] [<object_type>] [<expression>] [<options>]
Retrieve and display audit log entries from component or service.
If neither \f[C]-w\f[R] nor \f[C]-W\f[R] is specified, \f[C]tbaudit\f[R]
will display a snapshot of all messages matching the identifiers
historically.
.TP
\f[B]\f[CB]tbaudit archive\f[B]\f[R] <component_name> <destination_directory> [\f[B]\f[CB]-k date le\f[B]\f[R] <split_date>]
Pack component audit to an archive in the destination directory.
Default archive name is
<component_name>\f[C]_archived_\f[R]<split_date>\f[C].tar.gz\f[R]
.RS
.PP
If <split_date> is specified, all audit records newer than this date
will be left in the audit databases, and older records will be moved to
the archive.
If <split_date> is not specified, the command archives records for last
31 days.
To specify a date, use the standard format:
\f[C]<yyyy-mm-dd>[hh:mm][:ss][.uuuuuu] [TimeZone]\f[R].
.PP
Besides the records newer than specified datetime, after archiving the
component audit contains snapshots for all objects which history starts
before the splitting datetime.
.PP
For example, the audit of a single object in the original audit DB is
presented as the following sequence of messages:
.IP "1." 3
message with host_modified_dt = 2020-01-01
.IP "2." 3
message with host_modified_dt = 2020-01-02
.IP "3." 3
message with host_modified_dt = 2020-01-04
.PP
When you archive the audit and set the split date to 2020-01-03, the
archive will contain messages 1 and 2, and the component audit will
contain a sequence of the following two messages:
.IP "1." 3
message 1 merged with message 2
.IP "2." 3
message 3
.PP
When the created archive is merged back to the component audit using the
\f[C]tbaudit restore\f[R] command, the snapshots that were created
during the archiving, are removed.
So if the archive from the example above is merged back to the component
audit, the audit of the object will be the same as initial.
.PP
The following components support audit archiving:
.IP \[bu] 2
Strategy Engine
.IP \[bu] 2
Limit Engine
.IP \[bu] 2
Distribution Engine
.IP \[bu] 2
Integration Engine
.IP \[bu] 2
Accessory Engine
.IP \[bu] 2
Metadata
.IP \[bu] 2
XRayPersistence
.IP \[bu] 2
Order Persistence
.IP \[bu] 2
Trade Persistence
.IP \[bu] 2
Instrument
.PP
Stop the component before archiving its audit.
.PP
Execute the command only on the same node as the component to which it
is applied.
.RE
.TP
\f[B]\f[CB]tbaudit restore\f[B]\f[R] <component_name> <path_to_archive_file> \f[B]\f[CB][--dry_run]\f[B]\f[R]
Restore audit logs of a component from the archive created by the
\f[C]tbaudit archive\f[R] command.
.RS
.PP
Archives can only be restored in reverse order to the one in which they
were created.
At this, no gaps are allowed between archived audit and component audit,
i.e.\ archive can be restored only to the point from which it was
detached.
Before merging, the command checks that the archive can be merged into
the component audit.
This can be illustrated by the following sequence of commands:
.IP
.nf
\f[C]
 tbaudit archive is ./ -k date le 2020-01-01 # creates ./ds_is1_archived_audit_2020-01-01-CET.tar.gz
 tbaudit archive is ./ -k date le 2020-01-02 # creates ./ds_is1_archived_audit_2020-01-02-CET.tar.gz
 tbaudit restore is ./ds_is1_archived_audit_2020-01-01-CET.tar.gz # fail
 tbaudit restore is ./ds_is1_archived_audit_2020-01-02-CET.tar.gz # success
 tbaudit restore is ./ds_is1_archived_audit_2020-01-02-CET.tar.gz # fail
 tbaudit restore is ./ds_is1_archived_audit_2020-01-01-CET.tar.gz # success
\f[R]
.fi
.PP
The \f[C]--dry_run\f[R] option is used to perform this check without the
actual merge.
.PP
Stop the component before restoring its audit.
.PP
Execute the command only on the same node as the component to which it
is applied.
.RE
.SH OPTIONS
.TP
\f[B]\f[CB]-w\f[B]\f[R]
Wait for new messages in addition to historical snapshot.
.TP
\f[B]\f[CB]-W\f[B]\f[R]
Wait for new messages without any historical snapshot.
.TP
\f[B]\f[CB]-f\f[B]\f[R] <format>
Specify the output format.
Custom format is only supported for Trade, Order, Cash and Portfolio
message types.
Format string is in the form of <col1>[=<val1>],<col2>[=<val2>],\&...
.TP
\f[B]\f[CB]--FS\f[B]\f[R] <field_separator>
Specify field separator (delimiter) for custom format.
.TP
\f[B]\f[CB]-p\f[B]\f[R] <portfolio_ID>
Request audit for the specified portfolio identifier.
.TP
\f[B]\f[CB]-c\f[B]\f[R] <parameter_context>
Request audit for the specified parameter context.
Possible contexts: Global, Trading, Risk, MM quoting, MM hidden, MM
quoting multi-level, MM shared.
.TP
\f[B]\f[CB]-r\f[B]\f[R] <ranking>
Possible rankings are: Trading, Risk, Underlying price source, Global,
MM hidden, MM quoting, MM shared, MM quoting multi-level.
.TP
\f[B]\f[CB]-u\f[B]\f[R] <user_ID>
Request audit for the specified user identifier.
.TP
\f[B]\f[CB]-i\f[B]\f[R] <stream_item_ID>
Request audit for the specified stream item identifier.
For the best performance, use this to filter objects by UUID for all
components except Trade Persistence and Order Persistence.
.TP
\f[B]\f[CB]-s\f[B]\f[R]
Enable stat request.
.TP
\f[B]\f[CB]--snapshot_date\f[B]\f[R] <date>
Filter by snapshot date.
.TP
\f[B]\f[CB]--file\f[B]\f[R] <path>
Path to the audit DB.
.TP
\f[B]\f[CB]--version\f[B]\f[R]
Print \f[C]tbaudit\f[R] version.
.TP
\f[B]\f[CB]-h, --help\f[B]\f[R]
Print help message.
.SS Object types
.PP
The following options allow to get audit data for specified object type,
if this is supported by the service.
Order Persistence service supports only objects of the Order type and
Engine services support only objects of the \f[B]StrategyInstance\f[R]
type.
.PP
\f[B]Instrument service:\f[R]
.IP \[bu] 2
\f[C]--instrument\f[R] (default)
.IP \[bu] 2
\f[C]--instrument_group\f[R]
.IP \[bu] 2
\f[C]--instrument_parameters\f[R]
.IP \[bu] 2
\f[C]--instrument_group_parameters\f[R]
.PP
\f[B]Distribution Center service:\f[R]
.IP \[bu] 2
\f[C]--resource\f[R] (default)
.PP
\f[B]Metadata service:\f[R]
.IP \[bu] 2
\f[C]--data_mapping\f[R] (default)
.IP \[bu] 2
\f[C]--user\f[R]
.IP \[bu] 2
\f[C]--role\f[R]
.IP \[bu] 2
\f[C]--user_preferences\f[R]
.IP \[bu] 2
\f[C]--grid_view_column\f[R]
.IP \[bu] 2
\f[C]--grid_view_column_attributes\f[R]
.IP \[bu] 2
\f[C]--table\f[R]
.IP \[bu] 2
\f[C]--ranking\f[R]
.IP \[bu] 2
\f[C]--parameter_context\f[R]
.IP \[bu] 2
\f[C]--enumeration\f[R]
.IP \[bu] 2
\f[C]--strategy_layout_element\f[R]
.IP \[bu] 2
\f[C]--strategy_layout\f[R]
.IP \[bu] 2
\f[C]--plugin\f[R]
.IP \[bu] 2
\f[C]--privilege\f[R]
.IP \[bu] 2
\f[C]--static_limit_rule\f[R]
.IP \[bu] 2
\f[C]--limit_settings\f[R]
.IP \[bu] 2
\f[C]--trading_block\f[R]
.IP \[bu] 2
\f[C]--throughput_rule\f[R]
.IP \[bu] 2
\f[C]--market_making_rule\f[R]
.IP \[bu] 2
\f[C]--tree_node\f[R]
.PP
\f[B]Trade Persistence service:\f[R]
.IP \[bu] 2
\f[C]-k trade\f[R] (default)
.IP \[bu] 2
\f[C]-k cash\f[R]
.IP \[bu] 2
\f[C]-k portfolio\f[R]
.SH EXAMPLES
.PP
\f[B]Show all audit log entries for instrument groups on component
\f[CB]is\f[B] with UUID
\f[CB]f7902af4-146a-11e7-b360-7f27a4022b51\f[B]:\f[R]
.IP
.nf
\f[C]
$ tbaudit is --instrument_group -i f7902af4-146a-11e7-b360-7f27a4022b51
\f[R]
.fi
.PP
\f[B]Show all trade audit log entries for a component \f[CB]tp\f[B] with
UUID \f[CB]ca0a237a-6729-11e7-9700-ff04a1896257\f[B]:\f[R]
.IP
.nf
\f[C]
$ tbaudit tp -k trade ca0a237a-6729-11e7-9700-ff04a1896257
\f[R]
.fi
.PP
\f[B]Show all cash audit log entries for a component \f[CB]tp\f[B]:\f[R]
.IP
.nf
\f[C]
$ tbaudit tp -k cash
\f[R]
.fi
.PP
\f[B]Show all audit log entries for a component \f[CB]ins\f[B] for the
May 30 2013:\f[R]
.IP
.nf
\f[C]
$ tbaudit ins -k date 20130530

<message> (41) Instrument, <protocol> (15) InstrumentReferenceDataProtocol, <size< [520]
 {
 cfi code = <string> \[dq]RWXXCX\[dq]
 cfi variant = <uint32> 0
 currency = <currency> SEK
\&.
\&.
\&.
$
\f[R]
.fi
.PP
\f[B]Show all audit log entries for a component \f[CB]ins\f[B] since May
29 2013:\f[R]
.IP
.nf
\f[C]
$ tbaudit ins -k date ge 20130529
\f[R]
.fi
.PP
\f[B]Audit resource with a name
\f[CB]Nordic_Equity_RefData.tip\f[B]:\f[R]
.IP
.nf
\f[C]
$ tbaudit --resource -k resource_name eq Nordic_Equity_RefData.tip

<message> (625) Resource, <protocol> (49) ResourceRepositoryProtocol, <size> [183]
   {
   host created datetime = 2013-05-06 14:16:43.873994 MSK
   host modified datetime = 2013-05-06 14:16:43.873994 MSK
\&.
\&.
\&.
 $
\f[R]
.fi
.PP
\f[B]Check audit log entries from a component \f[CB]ins\f[B] for
instrument with UUID
\f[CB]87d30bf2-c83b-11e2-ab4a-e370662dd9c2\f[B]:\f[R]
.IP
.nf
\f[C]
$ tbaudit ins --instrument -i 87d30bf2-c83b-11e2-ab4a-e370662dd9c2
\f[R]
.fi
.PP
\f[B]Dump instruments to audit_data file:\f[R]
.IP
.nf
\f[C]
$ tbaudit dump /opt/tbricks/audit/ea213e26-f004-11e1-052f-5145404d7d82/instruments > audit_data
$
\f[R]
.fi
.PP
\f[B]Audit \f[CB]mtd\f[B] log entries related to plugins and with stream
item id \f[CB]22694798-7428-11e2-8bbb-0c3e99245e0d\f[B]:\f[R]
.IP
.nf
\f[C]
$ tbaudit mtd --plugin -i 22694798-7428-11e2-8bbb-0c3e99245e0d
\f[R]
.fi
.PP
\f[B]Audit \f[CB]op\f[B] for order with id
\f[CB]b3242948-97a4-11e2-bed8-1edbbecd915d\f[B]:\f[R]
.IP
.nf
\f[C]
$ tbaudit op -k order b3242948-97a4-11e2-bed8-1edbbecd915d
\f[R]
.fi
.PP
\f[B]Audit \f[CB]tp\f[B] for portfolio with id
\f[CB]0ec155d4-292a-11e8-b706-f1f1bbe9ebb3\f[B]:\f[R]
.IP
.nf
\f[C]
$ tbaudit tp -k portfolio 0ec155d4-292a-11e8-b706-f1f1bbe9ebb3
\f[R]
.fi
.PP
\f[B]Archive audit records older than 2020-01-04 to the
\f[CB]./archive/\f[B] directly for the \f[CB]is\f[B] component:\f[R]
.IP
.nf
\f[C]
$ tbaudit archive is ./archive/ -k date le 2020-01-04
\f[R]
.fi
.PP
\f[B]Archive audit records older than 2020-01-04 12:00:00.000001 CET to
the \f[CB]./\f[B] directly for the \f[CB]op\f[B] component:\f[R]
.IP
.nf
\f[C]
$ tbaudit archive op ./ -k date le \[dq]2020-01-04 12:00:00.000001 CET\[dq]
\f[R]
.fi
.PP
\f[B]Restore audit records for the \f[CB]is\f[B] component:\f[R]
.IP
.nf
\f[C]
$ tbaudit restore is ./archive/ds_is1_archived_audit_2020-01-04-CET.tar.gz
\f[R]
.fi
.PP
\f[B]Check if the specified archive can be merged into an audit of the
\f[CB]is\f[B] component:\f[R]
.IP
.nf
\f[C]
$ tbaudit restore is ./archive/ds_is1_archived_audit_2020-01-04-CET.tar.gz --dry_run
\f[R]
.fi
.SH EXIT STATUS
.PP
The following exit values are returned:
.IP \[bu] 2
0: Successful completion.
.IP \[bu] 2
1: An error occurred.
.IP \[bu] 2
2: Invalid command line options were specified.
.SH SEE ALSO
.PP
\f[C]tbintro\f[R](1), \f[C]tbaudit\f[R](1), \f[C]tbcomponent\f[R](1),
\f[C]tbcore\f[R](1), \f[C]tblog\f[R](1), \f[C]tbnode\f[R](1),
\f[C]tbrelease\f[R](1), \f[C]tbresource\f[R](1), \f[C]tbservice\f[R](1),
\f[C]tbsubsystem\f[R](1), \f[C]tbsystem\f[R](1), \f[C]tbuser\f[R](1)
